<!DOCTYPE html>
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Polling App - Minimal Client</title>
</head>
<body>
  <h1>Polling App</h1>

  <h2>Login</h2>
  <input id="username" placeholder="Username" />
  <input id="password" type="password" placeholder="Password" />
  <button id="login-btn" onclick="login()">Login</button>
  <button id="logout-btn" onclick="logout()" style="display:none;">Logout</button>
  <p id="login-status">Non sei loggato</p>

  <h2>Crea Sondaggio</h2>
  <input id="poll-question" placeholder="Domanda" disabled />
  <button id="create-poll-btn" onclick="createPoll()" disabled>Crea</button>

  <h2>Lista Sondaggi</h2>
  <button onclick="loadPolls()">Ricarica</button>
  <ul id="polls-list"></ul>

  <script>
    let token = null;

    function updateUIOnLogin(isLoggedIn) {
      document.getElementById('login-status').textContent = isLoggedIn ? 'Sei loggato' : 'Non sei loggato';
      document.getElementById('username').disabled = isLoggedIn;
      document.getElementById('password').disabled = isLoggedIn;
      document.getElementById('login-btn').style.display = isLoggedIn ? 'none' : 'inline';
      document.getElementById('logout-btn').style.display = isLoggedIn ? 'inline' : 'none';
      document.getElementById('poll-question').disabled = !isLoggedIn;
      document.getElementById('create-poll-btn').disabled = !isLoggedIn;
    }

    async function login() {
      const res = await fetch('/api/token/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: document.getElementById('username').value,
          password: document.getElementById('password').value
        })
      });

      if (res.ok) {
        const data = await res.json();
        token = data.access;
        alert('Login effettuato!');
        updateUIOnLogin(true);
      } else {
        alert('Login fallito! Controlla username e password.');
      }
    }

    function logout() {
      token = null;
      alert('Sei uscito dal sistema');
      updateUIOnLogin(false);
    }

    async function createPoll() {
      const question = document.getElementById('poll-question').value;
      if (!question.trim()) {
        alert('Inserisci una domanda per il sondaggio');
        return;
      }
      const res = await fetch('/api/polls/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ question })
      });

      if (res.ok) {
        const data = await res.json();
        alert('Sondaggio creato con ID: ' + data.id);
        loadPolls();
        document.getElementById('poll-question').value = '';
      } else {
        alert('Errore nella creazione del sondaggio');
      }
    }

    async function loadPolls() {
      const res = await fetch('/api/polls/');
      if (res.ok) {
        const data = await res.json();
        const list = document.getElementById('polls-list');
        list.innerHTML = '';
        data.forEach(poll => {
          const li = document.createElement('li');
          li.textContent = `(${poll.id}) ${poll.question}`;
          list.appendChild(li);
        });
      } else {
        alert('Errore nel caricamento dei sondaggi');
      }
    }

    // Imposta UI iniziale (logout)
    updateUIOnLogin(false);
  </script>
</body>
</html>
