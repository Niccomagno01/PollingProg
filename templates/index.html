<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Polling App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0 auto;
      padding: 20px;
      max-width: 700px;
      background-color: #f4f4f4;
    }

    h1, h2 {
      color: #333;
    }

    input, button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
      font-size: 16px;
    }

    button {
      background-color: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }

    .hidden {
      display: none;
    }

    .poll {
      background: #fff;
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    .choice {
      margin-top: 5px;
    }

    .choice button {
      margin-left: 10px;
      font-size: 0.9em;
      padding: 5px 10px;
    }

    .message {
      color: green;
      font-weight: bold;
    }

    .error {
      color: red;
    }
  </style>
</head>
<body>

  <h1>Polling App</h1>

  <section id="auth-section">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <button onclick="logout()" class="hidden" id="logout-btn">Logout</button>
    <p id="status-msg"></p>
  </section>

  <section id="create-poll-section" class="hidden">
    <h2>Crea un nuovo sondaggio</h2>
    <input type="text" id="poll-question" placeholder="Domanda del sondaggio">
    <button onclick="createPoll()">Crea sondaggio</button>
  </section>

  <section id="add-choice-section" class="hidden">
    <h2>Aggiungi scelta</h2>
    <input type="number" id="poll-id" placeholder="ID sondaggio">
    <input type="text" id="choice-text" placeholder="Testo della scelta">
    <button onclick="addChoice()">Aggiungi scelta</button>
  </section>

  <section>
    <h2>Sondaggi disponibili</h2>
    <button onclick="loadPolls()">Aggiorna</button>
    <div id="polls-container"></div>
  </section>

<script>
  let token = null;

  function showMessage(msg, isError = false) {
    const el = document.getElementById("status-msg");
    el.textContent = msg;
    el.className = isError ? "error" : "message";
  }

  async function login() {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();

    try {
      const res = await fetch('/api/token/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      if (!res.ok) throw new Error("Credenziali non valide");

      const data = await res.json();
      token = data.access;
      showMessage("Login effettuato!");
      document.getElementById("logout-btn").classList.remove("hidden");
      document.getElementById("create-poll-section").classList.remove("hidden");
      document.getElementById("add-choice-section").classList.remove("hidden");
    } catch (e) {
      showMessage(e.message, true);
    }
  }

  function logout() {
    token = null;
    showMessage("Logout effettuato");
    document.getElementById("logout-btn").classList.add("hidden");
    document.getElementById("create-poll-section").classList.add("hidden");
    document.getElementById("add-choice-section").classList.add("hidden");
  }

  async function createPoll() {
    const question = document.getElementById("poll-question").value.trim();
    if (!question) return alert("Inserisci una domanda valida.");

    try {
      const res = await fetch('/api/polls/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ question })
      });

      if (!res.ok) throw new Error("Errore nella creazione del sondaggio");

      const data = await res.json();
      alert(`Sondaggio creato con ID: ${data.id}`);
      document.getElementById("poll-id").value = data.id;
      document.getElementById("poll-question").value = "";
      loadPolls();
    } catch (e) {
      alert(e.message);
    }
  }

  async function addChoice() {
    const pollId = document.getElementById("poll-id").value;
    const choiceText = document.getElementById("choice-text").value.trim();

    if (!pollId || !choiceText) return alert("Inserisci ID e testo della scelta");

    try {
      const res = await fetch(`/api/polls/${pollId}/choices/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ choice_text: choiceText })
      });

      if (!res.ok) throw new Error("Errore nell'aggiunta della scelta");

      alert("Scelta aggiunta con successo!");
      document.getElementById("choice-text").value = "";
      loadPolls();
    } catch (e) {
      alert(e.message);
    }
  }

  async function vote(pollId, choiceId) {
    try {
      const res = await fetch(`/api/polls/${pollId}/vote/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ choice: choiceId })
      });

      if (!res.ok) throw new Error("Errore nel voto");

      alert("Voto registrato!");
      loadPolls();
    } catch (e) {
      alert(e.message);
    }
  }

  async function loadPolls() {
    try {
      const res = await fetch('/api/polls/');
      const data = await res.json();

      const container = document.getElementById("polls-container");
      container.innerHTML = "";

      data.forEach(poll => {
        const div = document.createElement("div");
        div.className = "poll";

        const title = document.createElement("h3");
        title.textContent = `(${poll.id}) ${poll.question}`;
        div.appendChild(title);

        poll.choices.forEach(choice => {
          const p = document.createElement("p");
          p.className = "choice";
          p.textContent = `${choice.choice_text} (${choice.votes_count} voti)`;

          if (token) {
            const btn = document.createElement("button");
            btn.textContent = "Vota";
            btn.onclick = () => vote(poll.id, choice.id);
            p.appendChild(btn);
          }

          div.appendChild(p);
        });

        container.appendChild(div);
      });
    } catch (e) {
      alert("Errore nel caricamento dei sondaggi");
    }
  }

  loadPolls();
</script>

</body>
</html>
