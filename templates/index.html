<!DOCTYPE html>
<html>
<head>
  <title>Polling App - Minimal Client</title>
  <meta charset="UTF-8" />
</head>
<body>
  <h1>Polling App</h1>

  <h2>Login</h2>
  <input id="username" placeholder="Username" />
  <input id="password" type="password" placeholder="Password" />
  <button onclick="login()">Login</button>
  <p id="login-status"></p>

  <h2>Crea Sondaggio</h2>
  <input id="poll-question" placeholder="Domanda" />
  <button onclick="createPoll()">Crea Sondaggio</button>

  <h2>Aggiungi Scelte</h2>
  <input id="choice-text" placeholder="Testo scelta" />
  <input id="poll-id-for-choice" placeholder="ID sondaggio" />
  <button onclick="addChoice()">Aggiungi Scelta</button>

  <h2>Lista Sondaggi</h2>
  <button onclick="loadPolls()">Ricarica</button>
  <ul id="polls-list"></ul>

  <script>
    let token = null;

    async function login() {
      const res = await fetch('/api/token/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: document.getElementById('username').value,
          password: document.getElementById('password').value
        })
      });
      const loginStatus = document.getElementById('login-status');
      if (!res.ok) {
        loginStatus.textContent = 'Login fallito';
        return;
      }
      const data = await res.json();
      token = data.access;
      loginStatus.textContent = 'Login effettuato!';
    }

    async function createPoll() {
      if (!token) { alert('Devi prima effettuare il login'); return; }
      const question = document.getElementById('poll-question').value.trim();
      if (!question) { alert('Inserisci la domanda'); return; }
      const res = await fetch('/api/polls/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ question })
      });
      if (!res.ok) {
        alert('Errore nella creazione del sondaggio');
        return;
      }
      const data = await res.json();
      alert('Sondaggio creato con ID: ' + data.id);
      document.getElementById('poll-id-for-choice').value = data.id;
      document.getElementById('poll-question').value = '';
    }

    async function addChoice() {
      if (!token) { alert('Devi prima effettuare il login'); return; }
      const choice_text = document.getElementById('choice-text').value.trim();
      const poll_id = document.getElementById('poll-id-for-choice').value.trim();
      if (!choice_text || !poll_id) {
        alert('Inserisci testo scelta e ID sondaggio');
        return;
      }
      const res = await fetch(`/api/polls/${poll_id}/choices/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ choice_text })
      });
      if (!res.ok) {
        const err = await res.json();
        alert('Errore nell\'aggiunta della scelta: ' + (err.error || JSON.stringify(err)));
        return;
      }
      alert('Scelta aggiunta con successo!');
      document.getElementById('choice-text').value = '';
      loadPolls();
    }

    async function vote(pollId, choiceId) {
      if (!token) { alert('Devi prima effettuare il login'); return; }
      const res = await fetch(`/api/polls/${pollId}/vote/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ choice: choiceId })
      });
      if (!res.ok) {
        const err = await res.json();
        alert('Errore nel voto: ' + (err.error || JSON.stringify(err)));
        return;
      }
      alert('Voto registrato con successo!');
      loadPolls();
    }

    async function loadPolls() {
      const res = await fetch('/api/polls/');
      if (!res.ok) {
        alert('Errore nel caricamento sondaggi');
        return;
      }
      const data = await res.json();
      const list = document.getElementById('polls-list');
      list.innerHTML = '';
      data.forEach(poll => {
        const li = document.createElement('li');
        li.textContent = `(${poll.id}) ${poll.question}`;

        if (poll.choices && poll.choices.length > 0) {
          const choicesUl = document.createElement('ul');
          poll.choices.forEach(choice => {
            const choiceLi = document.createElement('li');
            choiceLi.textContent = `${choice.choice_text} (voti: ${choice.votes_count})`;
            // Aggiungo bottone voto se loggato
            if(token) {
              const voteBtn = document.createElement('button');
              voteBtn.textContent = 'Vota';
              voteBtn.onclick = () => vote(poll.id, choice.id);
              choiceLi.appendChild(voteBtn);
            }
            choicesUl.appendChild(choiceLi);
          });
          li.appendChild(choicesUl);
        }
        list.appendChild(li);
      });
    }
  </script>
</body>
</html>

